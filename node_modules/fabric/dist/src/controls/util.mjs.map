{"version":3,"file":"util.mjs","sources":["../../../src/controls/util.ts"],"sourcesContent":["import type {\n  TPointerEvent,\n  Transform,\n  TransformAction,\n  BasicTransformEvent,\n} from '../EventTypeDefs';\nimport { resolveOrigin } from '../util/misc/resolveOrigin';\nimport { Point } from '../Point';\nimport type { FabricObject } from '../shapes/Object/FabricObject';\nimport type { TOriginX, TOriginY } from '../typedefs';\nimport { degreesToRadians } from '../util/misc/radiansDegreesConversion';\nimport type { Control } from './Control';\nimport { CENTER, quarterPI, twoMathPi } from '../constants';\nimport { calcVectorRotation, createVector } from '../util/misc/vectors';\nimport type { TOCoord } from '../shapes/Object/InteractiveObject';\nimport { sendPointToPlane } from '../util/misc/planeChange';\n\nexport const NOT_ALLOWED_CURSOR = 'not-allowed';\n\n/**\n * @param {Boolean} alreadySelected true if target is already selected\n * @param {String} corner a string representing the corner ml, mr, tl ...\n * @param {Event} e Event object\n * @param {FabricObject} [target] inserted back to help overriding. Unused\n */\nexport const getActionFromCorner = (\n  alreadySelected: boolean,\n  corner: string | undefined,\n  e: TPointerEvent,\n  target: FabricObject,\n) => {\n  if (!corner || !alreadySelected) {\n    return 'drag';\n  }\n  const control = target.controls[corner];\n  return control.getActionName(e, control, target);\n};\n\n/**\n * Checks if transform is centered\n * @param {Object} transform transform data\n * @return {Boolean} true if transform is centered\n */\nexport function isTransformCentered(transform: Transform) {\n  return (\n    resolveOrigin(transform.originX) === resolveOrigin(CENTER) &&\n    resolveOrigin(transform.originY) === resolveOrigin(CENTER)\n  );\n}\n\nexport function invertOrigin(origin: TOriginX | TOriginY) {\n  return -resolveOrigin(origin) + 0.5;\n}\n\nexport const isLocked = (\n  target: FabricObject,\n  lockingKey:\n    | 'lockMovementX'\n    | 'lockMovementY'\n    | 'lockRotation'\n    | 'lockScalingX'\n    | 'lockScalingY'\n    | 'lockSkewingX'\n    | 'lockSkewingY'\n    | 'lockScalingFlip',\n) => target[lockingKey];\n\nexport const commonEventInfo: TransformAction<\n  Transform,\n  BasicTransformEvent\n> = (eventData, transform, x, y) => {\n  return {\n    e: eventData,\n    transform,\n    pointer: new Point(x, y),\n  };\n};\n\n/**\n * Combine control position and object angle to find the control direction compared\n * to the object center.\n * @param {FabricObject} fabricObject the fabric object for which we are rendering controls\n * @param {Control} control the control class\n * @return {Number} 0 - 7 a quadrant number\n */\nexport function findCornerQuadrant(\n  fabricObject: FabricObject,\n  control: Control,\n  coord: TOCoord,\n): number {\n  const target = coord;\n  const center = sendPointToPlane(\n    fabricObject.getCenterPoint(),\n    fabricObject.canvas!.viewportTransform,\n    undefined,\n  );\n  const angle = calcVectorRotation(createVector(center, target)) + twoMathPi;\n  return Math.round((angle % twoMathPi) / quarterPI);\n}\n\n/**\n * @returns the normalized point (rotated relative to center) in local coordinates\n */\nfunction normalizePoint(\n  target: FabricObject,\n  point: Point,\n  originX: TOriginX,\n  originY: TOriginY,\n): Point {\n  const center = target.getRelativeCenterPoint(),\n    p =\n      typeof originX !== 'undefined' && typeof originY !== 'undefined'\n        ? target.translateToGivenOrigin(\n            center,\n            CENTER,\n            CENTER,\n            originX,\n            originY,\n          )\n        : new Point(target.left, target.top),\n    p2 = target.angle\n      ? point.rotate(-degreesToRadians(target.angle), center)\n      : point;\n  return p2.subtract(p);\n}\n\n/**\n * Transforms a point to the offset from the given origin\n * @param {Object} transform\n * @param {String} originX\n * @param {String} originY\n * @param {number} x\n * @param {number} y\n * @return {Fabric.Point} the normalized point\n */\nexport function getLocalPoint(\n  { target, corner }: Transform,\n  originX: TOriginX,\n  originY: TOriginY,\n  x: number,\n  y: number,\n) {\n  const control = target.controls[corner],\n    zoom = target.canvas?.getZoom() || 1,\n    padding = target.padding / zoom,\n    localPoint = normalizePoint(target, new Point(x, y), originX, originY);\n  if (localPoint.x >= padding) {\n    localPoint.x -= padding;\n  }\n  if (localPoint.x <= -padding) {\n    localPoint.x += padding;\n  }\n  if (localPoint.y >= padding) {\n    localPoint.y -= padding;\n  }\n  if (localPoint.y <= padding) {\n    localPoint.y += padding;\n  }\n  localPoint.x -= control.offsetX;\n  localPoint.y -= control.offsetY;\n  return localPoint;\n}\n"],"names":["NOT_ALLOWED_CURSOR","getActionFromCorner","alreadySelected","corner","e","target","control","controls","getActionName","isTransformCentered","transform","resolveOrigin","originX","CENTER","originY","invertOrigin","origin","isLocked","lockingKey","commonEventInfo","eventData","x","y","pointer","Point","findCornerQuadrant","fabricObject","coord","center","sendPointToPlane","getCenterPoint","canvas","viewportTransform","undefined","angle","calcVectorRotation","createVector","twoMathPi","Math","round","quarterPI","normalizePoint","point","getRelativeCenterPoint","p","translateToGivenOrigin","left","top","p2","rotate","degreesToRadians","subtract","getLocalPoint","_ref","_target$canvas","zoom","getZoom","padding","localPoint","offsetX","offsetY"],"mappings":"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"}