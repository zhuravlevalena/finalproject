{"version":3,"file":"ITextClickBehavior.mjs","sources":["../../../../src/shapes/IText/ITextClickBehavior.ts"],"sourcesContent":["import type {\n  ObjectPointerEvents,\n  TPointerEvent,\n  TPointerEventInfo,\n} from '../../EventTypeDefs';\nimport { Point } from '../../Point';\nimport { invertTransform } from '../../util/misc/matrix';\nimport { DraggableTextDelegate } from './DraggableTextDelegate';\nimport type { ITextEvents } from './ITextBehavior';\nimport { ITextKeyBehavior } from './ITextKeyBehavior';\nimport type { TOptions } from '../../typedefs';\nimport type { TextProps, SerializedTextProps } from '../Text/Text';\nimport type { IText } from './IText';\n/**\n * `LEFT_CLICK === 0`\n */\nconst notALeftClick = (e: Event) => !!(e as MouseEvent).button;\n\nexport abstract class ITextClickBehavior<\n  Props extends TOptions<TextProps> = Partial<TextProps>,\n  SProps extends SerializedTextProps = SerializedTextProps,\n  EventSpec extends ITextEvents = ITextEvents,\n> extends ITextKeyBehavior<Props, SProps, EventSpec> {\n  protected draggableTextDelegate: DraggableTextDelegate;\n\n  initBehavior() {\n    // Initializes event handlers related to cursor or selection\n    this.on('mousedown', this._mouseDownHandler);\n    this.on('mouseup', this.mouseUpHandler);\n    this.on('mousedblclick', this.doubleClickHandler);\n    this.on('mousetripleclick', this.tripleClickHandler);\n\n    this.draggableTextDelegate = new DraggableTextDelegate(\n      this as unknown as IText,\n    );\n\n    super.initBehavior();\n  }\n\n  /**\n   * If this method returns true a mouse move operation over a text selection\n   * will not prevent the native mouse event allowing the browser to start a drag operation.\n   * shouldStartDragging can be read 'do not prevent default for mouse move event'\n   * To prevent drag and drop between objects both shouldStartDragging and onDragStart should return false\n   * @returns\n   */\n  shouldStartDragging() {\n    return this.draggableTextDelegate.isActive();\n  }\n\n  /**\n   * @public override this method to control whether instance should/shouldn't become a drag source,\n   * @see also {@link DraggableTextDelegate#isActive}\n   * To prevent drag and drop between objects both shouldStartDragging and onDragStart should return false\n   * @returns {boolean} should handle event\n   */\n  onDragStart(e: DragEvent) {\n    return this.draggableTextDelegate.onDragStart(e);\n  }\n\n  /**\n   * @public override this method to control whether instance should/shouldn't become a drop target\n   */\n  canDrop(e: DragEvent) {\n    return this.draggableTextDelegate.canDrop(e);\n  }\n\n  /**\n   * Default handler for double click, select a word\n   */\n  doubleClickHandler(options: TPointerEventInfo) {\n    if (!this.isEditing) {\n      return;\n    }\n    this.selectWord(this.getSelectionStartFromPointer(options.e));\n    this.renderCursorOrSelection();\n  }\n\n  /**\n   * Default handler for triple click, select a line\n   */\n  tripleClickHandler(options: TPointerEventInfo) {\n    if (!this.isEditing) {\n      return;\n    }\n    this.selectLine(this.getSelectionStartFromPointer(options.e));\n    this.renderCursorOrSelection();\n  }\n\n  /**\n   * Default event handler for the basic functionalities needed on _mouseDown\n   * can be overridden to do something different.\n   * Scope of this implementation is: find the click position, set selectionStart\n   * find selectionEnd, initialize the drawing of either cursor or selection area\n   * initializing a mousedDown on a text area will cancel fabricjs knowledge of\n   * current compositionMode. It will be set to false.\n   */\n  _mouseDownHandler({ e, alreadySelected }: ObjectPointerEvents['mousedown']) {\n    if (\n      !this.canvas ||\n      !this.editable ||\n      notALeftClick(e) ||\n      this.getActiveControl()\n    ) {\n      return;\n    }\n\n    if (this.draggableTextDelegate.start(e)) {\n      return;\n    }\n\n    this.canvas.textEditingManager.register(this);\n\n    if (alreadySelected) {\n      this.inCompositionMode = false;\n      this.setCursorByClick(e);\n    }\n\n    if (this.isEditing) {\n      this.__selectionStartOnMouseDown = this.selectionStart;\n      if (this.selectionStart === this.selectionEnd) {\n        this.abortCursorAnimation();\n      }\n      this.renderCursorOrSelection();\n    }\n    this.selected ||= alreadySelected || this.isEditing;\n  }\n\n  /**\n   * standard handler for mouse up, overridable\n   * @private\n   */\n  mouseUpHandler({ e, transform }: ObjectPointerEvents['mouseup']) {\n    const didDrag = this.draggableTextDelegate.end(e);\n\n    if (this.canvas) {\n      this.canvas.textEditingManager.unregister(this);\n\n      const activeObject = this.canvas._activeObject;\n      if (activeObject && activeObject !== this) {\n        // avoid running this logic when there is an active object\n        // this because is possible with shift click and fast clicks,\n        // to rapidly deselect and reselect this object and trigger an enterEdit\n        return;\n      }\n    }\n\n    if (\n      !this.editable ||\n      (this.group && !this.group.interactive) ||\n      (transform && transform.actionPerformed) ||\n      notALeftClick(e) ||\n      didDrag\n    ) {\n      return;\n    }\n\n    if (this.selected && !this.getActiveControl()) {\n      this.enterEditing(e);\n      if (this.selectionStart === this.selectionEnd) {\n        this.initDelayedCursor(true);\n      } else {\n        this.renderCursorOrSelection();\n      }\n    }\n  }\n\n  /**\n   * Changes cursor location in a text depending on passed pointer (x/y) object\n   * @param {TPointerEvent} e Event object\n   */\n  setCursorByClick(e: TPointerEvent) {\n    const newSelection = this.getSelectionStartFromPointer(e),\n      start = this.selectionStart,\n      end = this.selectionEnd;\n    if (e.shiftKey) {\n      this.setSelectionStartEndWithShift(start, end, newSelection);\n    } else {\n      this.selectionStart = newSelection;\n      this.selectionEnd = newSelection;\n    }\n    if (this.isEditing) {\n      this._fireSelectionChanged();\n      this._updateTextarea();\n    }\n  }\n\n  /**\n   * Returns index of a character corresponding to where an object was clicked\n   * @param {TPointerEvent} e Event object\n   * @return {Number} Index of a character\n   */\n  getSelectionStartFromPointer(e: TPointerEvent): number {\n    const mouseOffset = this.canvas!.getScenePoint(e)\n      .transform(invertTransform(this.calcTransformMatrix()))\n      .add(new Point(-this._getLeftOffset(), -this._getTopOffset()));\n    let height = 0,\n      charIndex = 0,\n      lineIndex = 0;\n\n    for (let i = 0; i < this._textLines.length; i++) {\n      if (height <= mouseOffset.y) {\n        height += this.getHeightOfLine(i);\n        lineIndex = i;\n        if (i > 0) {\n          charIndex +=\n            this._textLines[i - 1].length + this.missingNewlineOffset(i - 1);\n        }\n      } else {\n        break;\n      }\n    }\n    const lineLeftOffset = Math.abs(this._getLineLeftOffset(lineIndex));\n    let width = lineLeftOffset;\n    const charLength = this._textLines[lineIndex].length;\n    const chars = this.__charBounds[lineIndex];\n    for (let j = 0; j < charLength; j++) {\n      // i removed something about flipX here, check.\n      const charWidth = chars[j].kernedWidth;\n      const widthAfter = width + charWidth;\n      if (mouseOffset.x <= widthAfter) {\n        // if the pointer is closer to the end of the char we increment charIndex\n        // in order to position the cursor after the char\n        if (\n          Math.abs(mouseOffset.x - widthAfter) <=\n          Math.abs(mouseOffset.x - width)\n        ) {\n          charIndex++;\n        }\n        break;\n      }\n      width = widthAfter;\n      charIndex++;\n    }\n\n    return Math.min(\n      // if object is horizontally flipped, mirror cursor location from the end\n      this.flipX ? charLength - charIndex : charIndex,\n      this._text.length,\n    );\n  }\n}\n"],"names":["notALeftClick","e","button","ITextClickBehavior","ITextKeyBehavior","constructor","arguments","_defineProperty","initBehavior","on","_mouseDownHandler","mouseUpHandler","doubleClickHandler","tripleClickHandler","draggableTextDelegate","DraggableTextDelegate","shouldStartDragging","isActive","onDragStart","canDrop","options","isEditing","selectWord","getSelectionStartFromPointer","renderCursorOrSelection","selectLine","_ref","alreadySelected","canvas","editable","getActiveControl","start","textEditingManager","register","inCompositionMode","setCursorByClick","__selectionStartOnMouseDown","selectionStart","selectionEnd","abortCursorAnimation","selected","_ref2","transform","didDrag","end","unregister","activeObject","_activeObject","group","interactive","actionPerformed","enterEditing","initDelayedCursor","newSelection","shiftKey","setSelectionStartEndWithShift","_fireSelectionChanged","_updateTextarea","mouseOffset","getScenePoint","invertTransform","calcTransformMatrix","add","Point","_getLeftOffset","_getTopOffset","height","charIndex","lineIndex","i","_textLines","length","y","getHeightOfLine","missingNewlineOffset","lineLeftOffset","Math","abs","_getLineLeftOffset","width","charLength","chars","__charBounds","j","charWidth","kernedWidth","widthAfter","x","min","flipX","_text"],"mappings":";;;;;;AAaA;AACA;AACA;AACA,MAAMA,aAAa,GAAIC,CAAQ,IAAK,CAAC,CAAEA,CAAC,CAAgBC,MAAM;AAEvD,MAAeC,kBAAkB,SAI9BC,gBAAgB,CAA2B;EAAAC,WAAAA,GAAA;AAAA,IAAA,KAAA,CAAA,GAAAC,SAAA,CAAA;IAAAC,eAAA,CAAA,IAAA,EAAA,uBAAA,EAAA,MAAA,CAAA;AAAA,EAAA;AAGnDC,EAAAA,YAAYA,GAAG;AACb;IACA,IAAI,CAACC,EAAE,CAAC,WAAW,EAAE,IAAI,CAACC,iBAAiB,CAAC;IAC5C,IAAI,CAACD,EAAE,CAAC,SAAS,EAAE,IAAI,CAACE,cAAc,CAAC;IACvC,IAAI,CAACF,EAAE,CAAC,eAAe,EAAE,IAAI,CAACG,kBAAkB,CAAC;IACjD,IAAI,CAACH,EAAE,CAAC,kBAAkB,EAAE,IAAI,CAACI,kBAAkB,CAAC;AAEpD,IAAA,IAAI,CAACC,qBAAqB,GAAG,IAAIC,qBAAqB,CACpD,IACF,CAAC;IAED,KAAK,CAACP,YAAY,EAAE;AACtB,EAAA;;AAEA;AACF;AACA;AACA;AACA;AACA;AACA;AACEQ,EAAAA,mBAAmBA,GAAG;AACpB,IAAA,OAAO,IAAI,CAACF,qBAAqB,CAACG,QAAQ,EAAE;AAC9C,EAAA;;AAEA;AACF;AACA;AACA;AACA;AACA;EACEC,WAAWA,CAACjB,CAAY,EAAE;AACxB,IAAA,OAAO,IAAI,CAACa,qBAAqB,CAACI,WAAW,CAACjB,CAAC,CAAC;AAClD,EAAA;;AAEA;AACF;AACA;EACEkB,OAAOA,CAAClB,CAAY,EAAE;AACpB,IAAA,OAAO,IAAI,CAACa,qBAAqB,CAACK,OAAO,CAAClB,CAAC,CAAC;AAC9C,EAAA;;AAEA;AACF;AACA;EACEW,kBAAkBA,CAACQ,OAA0B,EAAE;AAC7C,IAAA,IAAI,CAAC,IAAI,CAACC,SAAS,EAAE;AACnB,MAAA;AACF,IAAA;IACA,IAAI,CAACC,UAAU,CAAC,IAAI,CAACC,4BAA4B,CAACH,OAAO,CAACnB,CAAC,CAAC,CAAC;IAC7D,IAAI,CAACuB,uBAAuB,EAAE;AAChC,EAAA;;AAEA;AACF;AACA;EACEX,kBAAkBA,CAACO,OAA0B,EAAE;AAC7C,IAAA,IAAI,CAAC,IAAI,CAACC,SAAS,EAAE;AACnB,MAAA;AACF,IAAA;IACA,IAAI,CAACI,UAAU,CAAC,IAAI,CAACF,4BAA4B,CAACH,OAAO,CAACnB,CAAC,CAAC,CAAC;IAC7D,IAAI,CAACuB,uBAAuB,EAAE;AAChC,EAAA;;AAEA;AACF;AACA;AACA;AACA;AACA;AACA;AACA;EACEd,iBAAiBA,CAAAgB,IAAA,EAA2D;IAAA,IAA1D;MAAEzB,CAAC;AAAE0B,MAAAA;AAAkD,KAAC,GAAAD,IAAA;IACxE,IACE,CAAC,IAAI,CAACE,MAAM,IACZ,CAAC,IAAI,CAACC,QAAQ,IACd7B,aAAa,CAACC,CAAC,CAAC,IAChB,IAAI,CAAC6B,gBAAgB,EAAE,EACvB;AACA,MAAA;AACF,IAAA;IAEA,IAAI,IAAI,CAAChB,qBAAqB,CAACiB,KAAK,CAAC9B,CAAC,CAAC,EAAE;AACvC,MAAA;AACF,IAAA;IAEA,IAAI,CAAC2B,MAAM,CAACI,kBAAkB,CAACC,QAAQ,CAAC,IAAI,CAAC;AAE7C,IAAA,IAAIN,eAAe,EAAE;MACnB,IAAI,CAACO,iBAAiB,GAAG,KAAK;AAC9B,MAAA,IAAI,CAACC,gBAAgB,CAAClC,CAAC,CAAC;AAC1B,IAAA;IAEA,IAAI,IAAI,CAACoB,SAAS,EAAE;AAClB,MAAA,IAAI,CAACe,2BAA2B,GAAG,IAAI,CAACC,cAAc;AACtD,MAAA,IAAI,IAAI,CAACA,cAAc,KAAK,IAAI,CAACC,YAAY,EAAE;QAC7C,IAAI,CAACC,oBAAoB,EAAE;AAC7B,MAAA;MACA,IAAI,CAACf,uBAAuB,EAAE;AAChC,IAAA;IACA,IAAI,CAACgB,QAAQ,KAAb,IAAI,CAACA,QAAQ,GAAKb,eAAe,IAAI,IAAI,CAACN,SAAS,CAAA;AACrD,EAAA;;AAEA;AACF;AACA;AACA;EACEV,cAAcA,CAAA8B,KAAA,EAAmD;IAAA,IAAlD;MAAExC,CAAC;AAAEyC,MAAAA;AAA0C,KAAC,GAAAD,KAAA;IAC7D,MAAME,OAAO,GAAG,IAAI,CAAC7B,qBAAqB,CAAC8B,GAAG,CAAC3C,CAAC,CAAC;IAEjD,IAAI,IAAI,CAAC2B,MAAM,EAAE;MACf,IAAI,CAACA,MAAM,CAACI,kBAAkB,CAACa,UAAU,CAAC,IAAI,CAAC;AAE/C,MAAA,MAAMC,YAAY,GAAG,IAAI,CAAClB,MAAM,CAACmB,aAAa;AAC9C,MAAA,IAAID,YAAY,IAAIA,YAAY,KAAK,IAAI,EAAE;AACzC;AACA;AACA;AACA,QAAA;AACF,MAAA;AACF,IAAA;AAEA,IAAA,IACE,CAAC,IAAI,CAACjB,QAAQ,IACb,IAAI,CAACmB,KAAK,IAAI,CAAC,IAAI,CAACA,KAAK,CAACC,WAAY,IACtCP,SAAS,IAAIA,SAAS,CAACQ,eAAgB,IACxClD,aAAa,CAACC,CAAC,CAAC,IAChB0C,OAAO,EACP;AACA,MAAA;AACF,IAAA;IAEA,IAAI,IAAI,CAACH,QAAQ,IAAI,CAAC,IAAI,CAACV,gBAAgB,EAAE,EAAE;AAC7C,MAAA,IAAI,CAACqB,YAAY,CAAClD,CAAC,CAAC;AACpB,MAAA,IAAI,IAAI,CAACoC,cAAc,KAAK,IAAI,CAACC,YAAY,EAAE;AAC7C,QAAA,IAAI,CAACc,iBAAiB,CAAC,IAAI,CAAC;AAC9B,MAAA,CAAC,MAAM;QACL,IAAI,CAAC5B,uBAAuB,EAAE;AAChC,MAAA;AACF,IAAA;AACF,EAAA;;AAEA;AACF;AACA;AACA;EACEW,gBAAgBA,CAAClC,CAAgB,EAAE;AACjC,IAAA,MAAMoD,YAAY,GAAG,IAAI,CAAC9B,4BAA4B,CAACtB,CAAC,CAAC;MACvD8B,KAAK,GAAG,IAAI,CAACM,cAAc;MAC3BO,GAAG,GAAG,IAAI,CAACN,YAAY;IACzB,IAAIrC,CAAC,CAACqD,QAAQ,EAAE;MACd,IAAI,CAACC,6BAA6B,CAACxB,KAAK,EAAEa,GAAG,EAAES,YAAY,CAAC;AAC9D,IAAA,CAAC,MAAM;MACL,IAAI,CAAChB,cAAc,GAAGgB,YAAY;MAClC,IAAI,CAACf,YAAY,GAAGe,YAAY;AAClC,IAAA;IACA,IAAI,IAAI,CAAChC,SAAS,EAAE;MAClB,IAAI,CAACmC,qBAAqB,EAAE;MAC5B,IAAI,CAACC,eAAe,EAAE;AACxB,IAAA;AACF,EAAA;;AAEA;AACF;AACA;AACA;AACA;EACElC,4BAA4BA,CAACtB,CAAgB,EAAU;AACrD,IAAA,MAAMyD,WAAW,GAAG,IAAI,CAAC9B,MAAM,CAAE+B,aAAa,CAAC1D,CAAC,CAAC,CAC9CyC,SAAS,CAACkB,eAAe,CAAC,IAAI,CAACC,mBAAmB,EAAE,CAAC,CAAC,CACtDC,GAAG,CAAC,IAAIC,KAAK,CAAC,CAAC,IAAI,CAACC,cAAc,EAAE,EAAE,CAAC,IAAI,CAACC,aAAa,EAAE,CAAC,CAAC;IAChE,IAAIC,MAAM,GAAG,CAAC;AACZC,MAAAA,SAAS,GAAG,CAAC;AACbC,MAAAA,SAAS,GAAG,CAAC;AAEf,IAAA,KAAK,IAAIC,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAG,IAAI,CAACC,UAAU,CAACC,MAAM,EAAEF,CAAC,EAAE,EAAE;AAC/C,MAAA,IAAIH,MAAM,IAAIR,WAAW,CAACc,CAAC,EAAE;AAC3BN,QAAAA,MAAM,IAAI,IAAI,CAACO,eAAe,CAACJ,CAAC,CAAC;AACjCD,QAAAA,SAAS,GAAGC,CAAC;QACb,IAAIA,CAAC,GAAG,CAAC,EAAE;AACTF,UAAAA,SAAS,IACP,IAAI,CAACG,UAAU,CAACD,CAAC,GAAG,CAAC,CAAC,CAACE,MAAM,GAAG,IAAI,CAACG,oBAAoB,CAACL,CAAC,GAAG,CAAC,CAAC;AACpE,QAAA;AACF,MAAA,CAAC,MAAM;AACL,QAAA;AACF,MAAA;AACF,IAAA;AACA,IAAA,MAAMM,cAAc,GAAGC,IAAI,CAACC,GAAG,CAAC,IAAI,CAACC,kBAAkB,CAACV,SAAS,CAAC,CAAC;IACnE,IAAIW,KAAK,GAAGJ,cAAc;IAC1B,MAAMK,UAAU,GAAG,IAAI,CAACV,UAAU,CAACF,SAAS,CAAC,CAACG,MAAM;AACpD,IAAA,MAAMU,KAAK,GAAG,IAAI,CAACC,YAAY,CAACd,SAAS,CAAC;IAC1C,KAAK,IAAIe,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAGH,UAAU,EAAEG,CAAC,EAAE,EAAE;AACnC;AACA,MAAA,MAAMC,SAAS,GAAGH,KAAK,CAACE,CAAC,CAAC,CAACE,WAAW;AACtC,MAAA,MAAMC,UAAU,GAAGP,KAAK,GAAGK,SAAS;AACpC,MAAA,IAAI1B,WAAW,CAAC6B,CAAC,IAAID,UAAU,EAAE;AAC/B;AACA;QACA,IACEV,IAAI,CAACC,GAAG,CAACnB,WAAW,CAAC6B,CAAC,GAAGD,UAAU,CAAC,IACpCV,IAAI,CAACC,GAAG,CAACnB,WAAW,CAAC6B,CAAC,GAAGR,KAAK,CAAC,EAC/B;AACAZ,UAAAA,SAAS,EAAE;AACb,QAAA;AACA,QAAA;AACF,MAAA;AACAY,MAAAA,KAAK,GAAGO,UAAU;AAClBnB,MAAAA,SAAS,EAAE;AACb,IAAA;IAEA,OAAOS,IAAI,CAACY,GAAG;AACb;AACA,IAAA,IAAI,CAACC,KAAK,GAAGT,UAAU,GAAGb,SAAS,GAAGA,SAAS,EAC/C,IAAI,CAACuB,KAAK,CAACnB,MACb,CAAC;AACH,EAAA;AACF;;;;"}