{"version":3,"file":"DraggableTextDelegate.mjs","sources":["../../../../src/shapes/IText/DraggableTextDelegate.ts"],"sourcesContent":["import type {\n  DragEventData,\n  DropEventData,\n  TPointerEvent,\n} from '../../EventTypeDefs';\nimport { Point } from '../../Point';\nimport type { IText } from './IText';\nimport { setStyle } from '../../util/internals/dom_style';\nimport { cloneStyles } from '../../util/internals/cloneStyles';\nimport type { TextStyleDeclaration } from '../Text/StyledText';\nimport { getDocumentFromElement } from '../../util/dom_misc';\nimport { CHANGED, NONE } from '../../constants';\n\n/**\n * #### Dragging IText/Textbox Lifecycle\n * - {@link start} is called from `mousedown` {@link IText#_mouseDownHandler} and determines if dragging should start by testing {@link isPointerOverSelection}\n * - if true `mousedown` {@link IText#_mouseDownHandler} is blocked to keep selection\n * - if the pointer moves, canvas fires numerous mousemove {@link Canvas#_onMouseMove} that we make sure **aren't** prevented ({@link IText#shouldStartDragging}) in order for the window to start a drag session\n * - once/if the session starts canvas calls {@link onDragStart} on the active object to determine if dragging should occur\n * - canvas fires relevant drag events that are handled by the handlers defined in this scope\n * - {@link end} is called from `mouseup` {@link IText#mouseUpHandler}, blocking IText default click behavior\n * - in case the drag session didn't occur, {@link end} handles a click, since logic to do so was blocked during `mousedown`\n */\nexport class DraggableTextDelegate {\n  readonly target: IText;\n  private __mouseDownInPlace = false;\n  private __dragStartFired = false;\n  private __isDraggingOver = false;\n  private __dragStartSelection?: {\n    selectionStart: number;\n    selectionEnd: number;\n  };\n  private __dragImageDisposer?: VoidFunction;\n  private _dispose?: () => void;\n\n  constructor(target: IText) {\n    this.target = target;\n    const disposers = [\n      this.target.on('dragenter', this.dragEnterHandler.bind(this)),\n      this.target.on('dragover', this.dragOverHandler.bind(this)),\n      this.target.on('dragleave', this.dragLeaveHandler.bind(this)),\n      this.target.on('dragend', this.dragEndHandler.bind(this)),\n      this.target.on('drop', this.dropHandler.bind(this)),\n    ];\n    this._dispose = () => {\n      disposers.forEach((d) => d());\n      this._dispose = undefined;\n    };\n  }\n\n  isPointerOverSelection(e: TPointerEvent) {\n    const target = this.target;\n    const newSelection = target.getSelectionStartFromPointer(e);\n    return (\n      target.isEditing &&\n      newSelection >= target.selectionStart &&\n      newSelection <= target.selectionEnd &&\n      target.selectionStart < target.selectionEnd\n    );\n  }\n\n  /**\n   * @public override this method to disable dragging and default to mousedown logic\n   */\n  start(e: TPointerEvent) {\n    return (this.__mouseDownInPlace = this.isPointerOverSelection(e));\n  }\n\n  /**\n   * @public override this method to disable dragging without discarding selection\n   */\n  isActive() {\n    return this.__mouseDownInPlace;\n  }\n\n  /**\n   * Ends interaction and sets cursor in case of a click\n   * @returns true if was active\n   */\n  end(e: TPointerEvent) {\n    const active = this.isActive();\n    if (active && !this.__dragStartFired) {\n      // mousedown has been blocked since `active` is true => cursor has not been set.\n      // `__dragStartFired` is false => dragging didn't occur, pointer didn't move and is over selection.\n      // meaning this is actually a click, `active` is a false positive.\n      this.target.setCursorByClick(e);\n      this.target.initDelayedCursor(true);\n    }\n    this.__mouseDownInPlace = false;\n    this.__dragStartFired = false;\n    this.__isDraggingOver = false;\n    return active;\n  }\n\n  getDragStartSelection() {\n    return this.__dragStartSelection;\n  }\n\n  /**\n   * Override to customize the drag image\n   * https://developer.mozilla.org/en-US/docs/Web/API/DataTransfer/setDragImage\n   */\n  setDragImage(\n    e: DragEvent,\n    {\n      selectionStart,\n      selectionEnd,\n    }: {\n      selectionStart: number;\n      selectionEnd: number;\n    },\n  ) {\n    const target = this.target;\n    const canvas = target.canvas!;\n    const flipFactor = new Point(target.flipX ? -1 : 1, target.flipY ? -1 : 1);\n    const boundaries = target._getCursorBoundaries(selectionStart);\n    const selectionPosition = new Point(\n      boundaries.left + boundaries.leftOffset,\n      boundaries.top + boundaries.topOffset,\n    ).multiply(flipFactor);\n    const pos = selectionPosition.transform(target.calcTransformMatrix());\n    const pointer = canvas.getScenePoint(e);\n    const diff = pointer.subtract(pos);\n    const retinaScaling = target.getCanvasRetinaScaling();\n    const bbox = target.getBoundingRect();\n    const correction = pos.subtract(new Point(bbox.left, bbox.top));\n    const vpt = canvas.viewportTransform;\n    const offset = correction.add(diff).transform(vpt, true);\n    //  prepare instance for drag image snapshot by making all non selected text invisible\n    const bgc = target.backgroundColor;\n    const styles = cloneStyles(target.styles);\n    target.backgroundColor = '';\n    const styleOverride = {\n      stroke: 'transparent',\n      fill: 'transparent',\n      textBackgroundColor: 'transparent',\n    };\n    target.setSelectionStyles(styleOverride, 0, selectionStart);\n    target.setSelectionStyles(styleOverride, selectionEnd, target.text.length);\n    target.dirty = true;\n    const dragImage = target.toCanvasElement({\n      enableRetinaScaling: canvas.enableRetinaScaling,\n      viewportTransform: true,\n    });\n    // restore values\n    target.backgroundColor = bgc;\n    target.styles = styles;\n    target.dirty = true;\n    //  position drag image offscreen\n    setStyle(dragImage, {\n      position: 'fixed',\n      left: `${-dragImage.width}px`,\n      border: NONE,\n      width: `${dragImage.width / retinaScaling}px`,\n      height: `${dragImage.height / retinaScaling}px`,\n    });\n    this.__dragImageDisposer && this.__dragImageDisposer();\n    this.__dragImageDisposer = () => {\n      dragImage.remove();\n    };\n    getDocumentFromElement(\n      (e.target || this.target.hiddenTextarea)! as HTMLElement,\n    ).body.appendChild(dragImage);\n    e.dataTransfer?.setDragImage(dragImage, offset.x, offset.y);\n  }\n\n  /**\n   * @returns {boolean} determines whether {@link target} should/shouldn't become a drag source\n   */\n  onDragStart(e: DragEvent): boolean {\n    this.__dragStartFired = true;\n    const target = this.target;\n    const active = this.isActive();\n    if (active && e.dataTransfer) {\n      const selection = (this.__dragStartSelection = {\n        selectionStart: target.selectionStart,\n        selectionEnd: target.selectionEnd,\n      });\n      const value = target._text\n        .slice(selection.selectionStart, selection.selectionEnd)\n        .join('');\n      const data = { text: target.text, value, ...selection };\n      e.dataTransfer.setData('text/plain', value);\n      e.dataTransfer.setData(\n        'application/fabric',\n        JSON.stringify({\n          value: value,\n          styles: target.getSelectionStyles(\n            selection.selectionStart,\n            selection.selectionEnd,\n            true,\n          ),\n        }),\n      );\n      e.dataTransfer.effectAllowed = 'copyMove';\n      this.setDragImage(e, data);\n    }\n    target.abortCursorAnimation();\n    return active;\n  }\n\n  /**\n   * use {@link targetCanDrop} to respect overriding\n   * @returns {boolean} determines whether {@link target} should/shouldn't become a drop target\n   */\n  canDrop(e: DragEvent): boolean {\n    if (\n      this.target.editable &&\n      !this.target.getActiveControl() &&\n      !e.defaultPrevented\n    ) {\n      if (this.isActive() && this.__dragStartSelection) {\n        //  drag source trying to drop over itself\n        //  allow dropping only outside of drag start selection\n        const index = this.target.getSelectionStartFromPointer(e);\n        const dragStartSelection = this.__dragStartSelection;\n        return (\n          index < dragStartSelection.selectionStart ||\n          index > dragStartSelection.selectionEnd\n        );\n      }\n      return true;\n    }\n    return false;\n  }\n\n  /**\n   * in order to respect overriding {@link IText#canDrop} we call that instead of calling {@link canDrop} directly\n   */\n  protected targetCanDrop(e: DragEvent) {\n    return this.target.canDrop(e);\n  }\n\n  dragEnterHandler({ e }: DragEventData) {\n    const canDrop = this.targetCanDrop(e);\n    if (!this.__isDraggingOver && canDrop) {\n      this.__isDraggingOver = true;\n    }\n  }\n\n  dragOverHandler(ev: DragEventData) {\n    const { e } = ev;\n    const canDrop = this.targetCanDrop(e);\n    if (!this.__isDraggingOver && canDrop) {\n      this.__isDraggingOver = true;\n    } else if (this.__isDraggingOver && !canDrop) {\n      //  drop state has changed\n      this.__isDraggingOver = false;\n    }\n    if (this.__isDraggingOver) {\n      //  can be dropped, inform browser\n      e.preventDefault();\n      //  inform event subscribers\n      ev.canDrop = true;\n      ev.dropTarget = this.target;\n    }\n  }\n\n  dragLeaveHandler() {\n    if (this.__isDraggingOver || this.isActive()) {\n      this.__isDraggingOver = false;\n    }\n  }\n\n  /**\n   * Override the `text/plain | application/fabric` types of {@link DragEvent#dataTransfer}\n   * in order to change the drop value or to customize styling respectively, by listening to the `drop:before` event\n   * https://developer.mozilla.org/en-US/docs/Web/API/HTML_Drag_and_Drop_API/Drag_operations#performing_a_drop\n   */\n  dropHandler(ev: DropEventData) {\n    const { e } = ev;\n    const didDrop = e.defaultPrevented;\n    this.__isDraggingOver = false;\n    // inform browser that the drop has been accepted\n    e.preventDefault();\n    let insert = e.dataTransfer?.getData('text/plain');\n    if (insert && !didDrop) {\n      const target = this.target;\n      const canvas = target.canvas!;\n      let insertAt = target.getSelectionStartFromPointer(e);\n      const { styles } = (\n        e.dataTransfer!.types.includes('application/fabric')\n          ? JSON.parse(e.dataTransfer!.getData('application/fabric'))\n          : {}\n      ) as { styles: TextStyleDeclaration[] };\n      const trailing = insert[Math.max(0, insert.length - 1)];\n      const selectionStartOffset = 0;\n      //  drag and drop in same instance\n      if (this.__dragStartSelection) {\n        const selectionStart = this.__dragStartSelection.selectionStart;\n        const selectionEnd = this.__dragStartSelection.selectionEnd;\n        if (insertAt > selectionStart && insertAt <= selectionEnd) {\n          insertAt = selectionStart;\n        } else if (insertAt > selectionEnd) {\n          insertAt -= selectionEnd - selectionStart;\n        }\n        target.removeChars(selectionStart, selectionEnd);\n        // prevent `dragend` from handling event\n        delete this.__dragStartSelection;\n      }\n      //  remove redundant line break\n      if (\n        target._reNewline.test(trailing) &&\n        (target._reNewline.test(target._text[insertAt]) ||\n          insertAt === target._text.length)\n      ) {\n        insert = insert.trimEnd();\n      }\n      //  inform subscribers\n      ev.didDrop = true;\n      ev.dropTarget = target;\n      //  finalize\n      target.insertChars(insert, styles, insertAt);\n      // can this part be moved in an outside event? andrea to check.\n      canvas.setActiveObject(target);\n      target.enterEditing(e);\n      target.selectionStart = Math.min(\n        insertAt + selectionStartOffset,\n        target._text.length,\n      );\n      target.selectionEnd = Math.min(\n        target.selectionStart + insert.length,\n        target._text.length,\n      );\n      target.hiddenTextarea!.value = target.text;\n      target._updateTextarea();\n      target.hiddenTextarea!.focus();\n      target.fire(CHANGED, {\n        index: insertAt + selectionStartOffset,\n        action: 'drop',\n      });\n      canvas.fire('text:changed', { target });\n      canvas.contextTopDirty = true;\n      canvas.requestRenderAll();\n    }\n  }\n\n  /**\n   * fired only on the drag source after drop (if occurred)\n   * handle changes to the drag source in case of a drop on another object or a cancellation\n   * https://developer.mozilla.org/en-US/docs/Web/API/HTML_Drag_and_Drop_API/Drag_operations#finishing_a_drag\n   */\n  dragEndHandler({ e }: DragEventData) {\n    if (this.isActive() && this.__dragStartFired) {\n      //  once the drop event finishes we check if we need to change the drag source\n      //  if the drag source received the drop we bail out since the drop handler has already handled logic\n      if (this.__dragStartSelection) {\n        const target = this.target;\n        const canvas = this.target.canvas!;\n        const { selectionStart, selectionEnd } = this.__dragStartSelection;\n        const dropEffect = e.dataTransfer?.dropEffect || NONE;\n        if (dropEffect === NONE) {\n          // pointer is back over selection\n          target.selectionStart = selectionStart;\n          target.selectionEnd = selectionEnd;\n          target._updateTextarea();\n          target.hiddenTextarea!.focus();\n        } else {\n          target.clearContextTop();\n          if (dropEffect === 'move') {\n            target.removeChars(selectionStart, selectionEnd);\n            target.selectionStart = target.selectionEnd = selectionStart;\n            target.hiddenTextarea &&\n              (target.hiddenTextarea.value = target.text);\n            target._updateTextarea();\n            target.fire(CHANGED, {\n              index: selectionStart,\n              action: 'dragend',\n            });\n            canvas.fire('text:changed', { target });\n            canvas.requestRenderAll();\n          }\n          target.exitEditing();\n        }\n      }\n    }\n\n    this.__dragImageDisposer && this.__dragImageDisposer();\n    delete this.__dragImageDisposer;\n    delete this.__dragStartSelection;\n    this.__isDraggingOver = false;\n  }\n\n  dispose() {\n    this._dispose && this._dispose();\n  }\n}\n"],"names":["DraggableTextDelegate","constructor","target","_defineProperty","disposers","on","dragEnterHandler","bind","dragOverHandler","dragLeaveHandler","dragEndHandler","dropHandler","_dispose","forEach","d","undefined","isPointerOverSelection","e","newSelection","getSelectionStartFromPointer","isEditing","selectionStart","selectionEnd","start","__mouseDownInPlace","isActive","end","active","__dragStartFired","setCursorByClick","initDelayedCursor","__isDraggingOver","getDragStartSelection","__dragStartSelection","setDragImage","_ref","_e$dataTransfer","canvas","flipFactor","Point","flipX","flipY","boundaries","_getCursorBoundaries","selectionPosition","left","leftOffset","top","topOffset","multiply","pos","transform","calcTransformMatrix","pointer","getScenePoint","diff","subtract","retinaScaling","getCanvasRetinaScaling","bbox","getBoundingRect","correction","vpt","viewportTransform","offset","add","bgc","backgroundColor","styles","cloneStyles","styleOverride","stroke","fill","textBackgroundColor","setSelectionStyles","text","length","dirty","dragImage","toCanvasElement","enableRetinaScaling","setStyle","position","width","border","NONE","height","__dragImageDisposer","remove","getDocumentFromElement","hiddenTextarea","body","appendChild","dataTransfer","x","y","onDragStart","selection","value","_text","slice","join","data","setData","JSON","stringify","getSelectionStyles","effectAllowed","abortCursorAnimation","canDrop","editable","getActiveControl","defaultPrevented","index","dragStartSelection","targetCanDrop","_ref2","ev","preventDefault","dropTarget","_e$dataTransfer2","didDrop","insert","getData","insertAt","types","includes","parse","trailing","Math","max","selectionStartOffset","removeChars","_reNewline","test","trimEnd","insertChars","setActiveObject","enterEditing","min","_updateTextarea","focus","fire","CHANGED","action","contextTopDirty","requestRenderAll","_ref3","_e$dataTransfer3","dropEffect","clearContextTop","exitEditing","dispose"],"mappings":"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"}