import{defineProperty as t}from"../../../_virtual/_rollupPluginBabelHelpers.min.mjs";import{Point as e}from"../../Point.min.mjs";import{setStyle as r}from"../../util/internals/dom_style.min.mjs";import{cloneStyles as i}from"../../util/internals/cloneStyles.min.mjs";import{getDocumentFromElement as a}from"../../util/dom_misc.min.mjs";import{NONE as s,CHANGED as n}from"../../constants.min.mjs";class o{constructor(e){t(this,"target",void 0),t(this,"__mouseDownInPlace",!1),t(this,"__dragStartFired",!1),t(this,"__isDraggingOver",!1),t(this,"__dragStartSelection",void 0),t(this,"__dragImageDisposer",void 0),t(this,"_dispose",void 0),this.target=e;const r=[this.target.on("dragenter",this.dragEnterHandler.bind(this)),this.target.on("dragover",this.dragOverHandler.bind(this)),this.target.on("dragleave",this.dragLeaveHandler.bind(this)),this.target.on("dragend",this.dragEndHandler.bind(this)),this.target.on("drop",this.dropHandler.bind(this))];this._dispose=()=>{r.forEach(t=>t()),this._dispose=void 0}}isPointerOverSelection(t){const e=this.target,r=e.getSelectionStartFromPointer(t);return e.isEditing&&r>=e.selectionStart&&r<=e.selectionEnd&&e.selectionStart<e.selectionEnd}start(t){return this.__mouseDownInPlace=this.isPointerOverSelection(t)}isActive(){return this.__mouseDownInPlace}end(t){const e=this.isActive();return e&&!this.__dragStartFired&&(this.target.setCursorByClick(t),this.target.initDelayedCursor(!0)),this.__mouseDownInPlace=!1,this.__dragStartFired=!1,this.__isDraggingOver=!1,e}getDragStartSelection(){return this.__dragStartSelection}setDragImage(t,n){var o;let{selectionStart:d,selectionEnd:g}=n;const l=this.target,c=l.canvas,h=new e(l.flipX?-1:1,l.flipY?-1:1),_=l._getCursorBoundaries(d),p=new e(_.left+_.leftOffset,_.top+_.topOffset).multiply(h).transform(l.calcTransformMatrix()),S=c.getScenePoint(t).subtract(p),v=l.getCanvasRetinaScaling(),m=l.getBoundingRect(),f=p.subtract(new e(m.left,m.top)),u=c.viewportTransform,D=f.add(S).transform(u,!0),x=l.backgroundColor,T=i(l.styles);l.backgroundColor="";const E={stroke:"transparent",fill:"transparent",textBackgroundColor:"transparent"};l.setSelectionStyles(E,0,d),l.setSelectionStyles(E,g,l.text.length),l.dirty=!0;const O=l.toCanvasElement({enableRetinaScaling:c.enableRetinaScaling,viewportTransform:!0});l.backgroundColor=x,l.styles=T,l.dirty=!0,r(O,{position:"fixed",left:-O.width+"px",border:s,width:O.width/v+"px",height:O.height/v+"px"}),this.__dragImageDisposer&&this.__dragImageDisposer(),this.__dragImageDisposer=()=>{O.remove()},a(t.target||this.target.hiddenTextarea).body.appendChild(O),null===(o=t.dataTransfer)||void 0===o||o.setDragImage(O,D.x,D.y)}onDragStart(t){this.__dragStartFired=!0;const e=this.target,r=this.isActive();if(r&&t.dataTransfer){const r=this.__dragStartSelection={selectionStart:e.selectionStart,selectionEnd:e.selectionEnd},i=e._text.slice(r.selectionStart,r.selectionEnd).join(""),a={text:e.text,value:i,...r};t.dataTransfer.setData("text/plain",i),t.dataTransfer.setData("application/fabric",JSON.stringify({value:i,styles:e.getSelectionStyles(r.selectionStart,r.selectionEnd,!0)})),t.dataTransfer.effectAllowed="copyMove",this.setDragImage(t,a)}return e.abortCursorAnimation(),r}canDrop(t){if(this.target.editable&&!this.target.getActiveControl()&&!t.defaultPrevented){if(this.isActive()&&this.__dragStartSelection){const e=this.target.getSelectionStartFromPointer(t),r=this.__dragStartSelection;return e<r.selectionStart||e>r.selectionEnd}return!0}return!1}targetCanDrop(t){return this.target.canDrop(t)}dragEnterHandler(t){let{e:e}=t;const r=this.targetCanDrop(e);!this.__isDraggingOver&&r&&(this.__isDraggingOver=!0)}dragOverHandler(t){const{e:e}=t,r=this.targetCanDrop(e);!this.__isDraggingOver&&r?this.__isDraggingOver=!0:this.__isDraggingOver&&!r&&(this.__isDraggingOver=!1),this.__isDraggingOver&&(e.preventDefault(),t.canDrop=!0,t.dropTarget=this.target)}dragLeaveHandler(){(this.__isDraggingOver||this.isActive())&&(this.__isDraggingOver=!1)}dropHandler(t){var e;const{e:r}=t,i=r.defaultPrevented;this.__isDraggingOver=!1,r.preventDefault();let a=null===(e=r.dataTransfer)||void 0===e?void 0:e.getData("text/plain");if(a&&!i){const e=this.target,i=e.canvas;let s=e.getSelectionStartFromPointer(r);const{styles:o}=r.dataTransfer.types.includes("application/fabric")?JSON.parse(r.dataTransfer.getData("application/fabric")):{},d=a[Math.max(0,a.length-1)],g=0;if(this.__dragStartSelection){const t=this.__dragStartSelection.selectionStart,r=this.__dragStartSelection.selectionEnd;s>t&&s<=r?s=t:s>r&&(s-=r-t),e.removeChars(t,r),delete this.__dragStartSelection}e._reNewline.test(d)&&(e._reNewline.test(e._text[s])||s===e._text.length)&&(a=a.trimEnd()),t.didDrop=!0,t.dropTarget=e,e.insertChars(a,o,s),i.setActiveObject(e),e.enterEditing(r),e.selectionStart=Math.min(s+g,e._text.length),e.selectionEnd=Math.min(e.selectionStart+a.length,e._text.length),e.hiddenTextarea.value=e.text,e._updateTextarea(),e.hiddenTextarea.focus(),e.fire(n,{index:s+g,action:"drop"}),i.fire("text:changed",{target:e}),i.contextTopDirty=!0,i.requestRenderAll()}}dragEndHandler(t){let{e:e}=t;if(this.isActive()&&this.__dragStartFired&&this.__dragStartSelection){var r;const t=this.target,i=this.target.canvas,{selectionStart:a,selectionEnd:o}=this.__dragStartSelection,d=(null===(r=e.dataTransfer)||void 0===r?void 0:r.dropEffect)||s;d===s?(t.selectionStart=a,t.selectionEnd=o,t._updateTextarea(),t.hiddenTextarea.focus()):(t.clearContextTop(),"move"===d&&(t.removeChars(a,o),t.selectionStart=t.selectionEnd=a,t.hiddenTextarea&&(t.hiddenTextarea.value=t.text),t._updateTextarea(),t.fire(n,{index:a,action:"dragend"}),i.fire("text:changed",{target:t}),i.requestRenderAll()),t.exitEditing())}this.__dragImageDisposer&&this.__dragImageDisposer(),delete this.__dragImageDisposer,delete this.__dragStartSelection,this.__isDraggingOver=!1}dispose(){this._dispose&&this._dispose()}}export{o as DraggableTextDelegate};
//# sourceMappingURL=DraggableTextDelegate.min.mjs.map
