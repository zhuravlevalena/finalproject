{"version":3,"file":"ColorMatrix.mjs","sources":["../../../src/filters/ColorMatrix.ts"],"sourcesContent":["import { BaseFilter } from './BaseFilter';\nimport type {\n  T2DPipelineState,\n  TMatColorMatrix,\n  TWebGLUniformLocationMap,\n} from './typedefs';\nimport { classRegistry } from '../ClassRegistry';\nimport { fragmentSource } from './shaders/colorMatrix';\n\nexport type ColorMatrixOwnProps = {\n  matrix: TMatColorMatrix;\n  colorsOnly: boolean;\n};\n\nexport const colorMatrixDefaultValues: ColorMatrixOwnProps = {\n  matrix: [1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0],\n  colorsOnly: true,\n};\n\n/**\n   * Color Matrix filter class\n   * @see {@link http://fabric5.fabricjs.com/image-filters|ImageFilters demo}\n   * @see {@link http://phoboslab.org/log/2013/11/fast-image-filters-with-webgl demo}\n   * @example <caption>Kodachrome filter</caption>\n   * const filter = new ColorMatrix({\n   *  matrix: [\n       1.1285582396593525, -0.3967382283601348, -0.03992559172921793, 0, 63.72958762196502,\n       -0.16404339962244616, 1.0835251566291304, -0.05498805115633132, 0, 24.732407896706203,\n       -0.16786010706155763, -0.5603416277695248, 1.6014850761964943, 0, 35.62982807460946,\n       0, 0, 0, 1, 0\n      ]\n   * });\n   * object.filters.push(filter);\n   * object.applyFilters();\n   */\nexport class ColorMatrix<\n  Name extends string = 'ColorMatrix',\n  OwnProps extends object = ColorMatrixOwnProps,\n  SerializedProps extends object = ColorMatrixOwnProps,\n> extends BaseFilter<Name, OwnProps, SerializedProps> {\n  /**\n   * Colormatrix for pixels.\n   * array of 20 floats. Numbers in positions 4, 9, 14, 19 loose meaning\n   * outside the -1, 1 range.\n   * 0.0039215686 is the part of 1 that get translated to 1 in 2d\n   * @param {Array} matrix array of 20 numbers.\n   */\n  declare matrix: ColorMatrixOwnProps['matrix'];\n\n  /**\n   * Lock the colormatrix on the color part, skipping alpha, mainly for non webgl scenario\n   * to save some calculation\n   * @type Boolean\n   * @default true\n   */\n  declare colorsOnly: ColorMatrixOwnProps['colorsOnly'];\n\n  static type = 'ColorMatrix';\n\n  static defaults = colorMatrixDefaultValues;\n\n  static uniformLocations = ['uColorMatrix', 'uConstants'];\n\n  getFragmentSource(): string {\n    return fragmentSource;\n  }\n\n  /**\n   * Apply the ColorMatrix operation to a Uint8Array representing the pixels of an image.\n   *\n   * @param {Object} options\n   * @param {ImageData} options.imageData The Uint8Array to be filtered.\n   */\n  applyTo2d(options: T2DPipelineState) {\n    const imageData = options.imageData,\n      data = imageData.data,\n      m = this.matrix,\n      colorsOnly = this.colorsOnly;\n\n    for (let i = 0; i < data.length; i += 4) {\n      const r = data[i];\n      const g = data[i + 1];\n      const b = data[i + 2];\n\n      data[i] = r * m[0] + g * m[1] + b * m[2] + m[4] * 255;\n      data[i + 1] = r * m[5] + g * m[6] + b * m[7] + m[9] * 255;\n      data[i + 2] = r * m[10] + g * m[11] + b * m[12] + m[14] * 255;\n      if (!colorsOnly) {\n        const a = data[i + 3];\n        data[i] += a * m[3];\n        data[i + 1] += a * m[8];\n        data[i + 2] += a * m[13];\n        data[i + 3] =\n          r * m[15] + g * m[16] + b * m[17] + a * m[18] + m[19] * 255;\n      }\n    }\n  }\n\n  /**\n   * Send data from this filter to its shader program's uniforms.\n   *\n   * @param {WebGLRenderingContext} gl The GL canvas context used to compile this filter's shader.\n   * @param {Object} uniformLocations A map of string uniform names to WebGLUniformLocation objects\n   */\n  sendUniformData(\n    gl: WebGLRenderingContext,\n    uniformLocations: TWebGLUniformLocationMap,\n  ) {\n    const m = this.matrix,\n      matrix = [\n        m[0],\n        m[1],\n        m[2],\n        m[3],\n        m[5],\n        m[6],\n        m[7],\n        m[8],\n        m[10],\n        m[11],\n        m[12],\n        m[13],\n        m[15],\n        m[16],\n        m[17],\n        m[18],\n      ],\n      constants = [m[4], m[9], m[14], m[19]];\n    gl.uniformMatrix4fv(uniformLocations.uColorMatrix, false, matrix);\n    gl.uniform4fv(uniformLocations.uConstants, constants);\n  }\n\n  toObject(): { type: Name } & SerializedProps {\n    return {\n      ...super.toObject(),\n      matrix: [...this.matrix] as TMatColorMatrix,\n    };\n  }\n}\n\nclassRegistry.setClass(ColorMatrix);\n"],"names":["colorMatrixDefaultValues","matrix","colorsOnly","ColorMatrix","BaseFilter","getFragmentSource","fragmentSource","applyTo2d","options","imageData","data","m","i","length","r","g","b","a","sendUniformData","gl","uniformLocations","constants","uniformMatrix4fv","uColorMatrix","uniform4fv","uConstants","toObject","_defineProperty","classRegistry","setClass"],"mappings":"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"}